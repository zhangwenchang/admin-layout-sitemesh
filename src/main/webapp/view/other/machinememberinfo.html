
<style type="text/css">
.page-search-box .form-group {
	width: 50%;
	float: left;
}

.page-search-box .form-group .form-control {
	height: 30px;
}

.jingque {
	position: absolute;
	top: 29px;
	left: 15px;
	font-size: 11px;
	line-height: 11px;
}

.jingque input {
	position: relative;
	top: -2px;
}

.higher-group {
	height: 30px;
}

.relative-top6 {
	position: relative;
	top: 6px;
}

.edit-member-ul li {
	list-style-type: none;
}

.edit-member-ul li .labels {
	display: inline-block;
	width: 112px;
}

.edit-member-ul li input, .edit-member-ul li select {
	width: 137px;
	margin-right: 12px;
}

</style>
<style>
.clearfix:after{height: 0;overflow:hidden; clear: both;display: block;}
.dataTables_wrapper { position: relative; }
.dataTables_wrapper .dataTables_length { position: absolute; top: 2px; left: 80px;  }
.modal .dataTables_wrapper .dataTables_length { position: relative; left: 0; top: 0; }
.DTTT_button_copy, .DTTT_button_csv, .DTTT_button_pdf, .DTTT_button_print { display: none; }
</style>
<section class="content-header">
	<h1>
		智能营销会员管理<small></small>
	</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i>主页</a></li>
		<li>其他管理</li>
		<li class="active">智能营销会员管理</li>
	</ol>
</section>
<section class="content">
	<div class="row">
		<div class="col-xs-12">
			<div class="box">
				<form class="form-horizontal page-search-box">
					<div class="box-body">
						<div class="form-group">
							<label for="membNo" class="col-sm-3 control-label">会员昵称:</label>
							<div class="col-sm-9">
								<input type="text" class="form-control" id="membNickname" placeholder="" aria-controls="example1">
							</div>
						</div>

						<div class="form-group">
							<label for="membNo" class="col-sm-3 control-label">嘎嘎号:</label>
							<div class="col-sm-9">
								<input type="text" class="form-control" id="membGagano">
							</div>
						</div>

						<div class="form-group">
							<label for="content" class="col-sm-3 control-label">会员类型：</label>
							<div class="col-sm-9">
								<select name="machineType" id="machineType" class="form-control">
									<option value="">全部</option>
									<option value="1">智能营销会员</option>
									<option value="2">运营营销会员</option>
								</select>
							</div>
						</div>
					</div>
					<div class="box-footer">
						<button type="button" onclick="search()" class="btn btn-primary search-btn">查询</button>

						<button type="button" onclick="bindView()" class="btn btn-primary search-btn">绑定机器账号</button>

						<button type="button" onclick="refreshCache()" class="btn btn-primary search-btn">刷新缓存</button>

						<!-- <button type="button" onclick="editTelView()" class="btn btn-primary">运营接收手机</button> -->
					</div>
				</form>

				<!-- /.box-header -->
				<div class="box-body mailbox-messages">
					<table id="memberinfo" class="table table-bordered table-hover">
						<thead>
							<tr>
								<th>ID</th>
								<th>头像</th>
								<th>昵称</th>
								<th>GAGA号</th>
								<th>注册时间</th>
								<th>操作</th>
							</tr>
						</thead>

					</table>
				</div>
			</div>
			<!-- /.box-body -->
		</div>

		<!-- /.box -->
	</div>
	<!-- /.col -->
	</div>
	<!-- /.row -->
</section>
<!-- /.content -->
</div>

<div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="ModalLabel">机器账号绑定</h4>
			</div>
			<div class="modal-body" id="bodycontent">
				<!-- 在这里添加一些文本 -->
				<div class="form-group">
					<label for="membNo" class="col-sm-3 control-label">嘎嘎号:</label>
					<div class="col-sm-9">
						<input type="text" class="form-control" id="membGagano">
					</div>
				</div>
				<div class="form-group">
					<label for="content" class="col-sm-2 control-label">会员类型：</label>
					<div class="col-sm-4">
						<select name="machineTypeSub1" id="machineTypeSub1" class="form-control">
							<option value="1">智能营销会员</option>
							<option value="2">运营营销会员</option>
						</select>
					</div>
				</div>
			</div>
			<div class="modal-footer" id="modalbutton"></div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal -->
</div>

<div class="modal fade" id="Modalpage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog" style="width: 60%">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="ModalLabelpage"></h4>
			</div>
			<div class="modal-body" id="bodycontentpage">
				<!-- 在这里添加一些文本 -->
			</div>
			<div class="modal-footer" id="modalbuttonpage"></div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal -->
</div>

<div class="modal fade" id="enableModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="enableModalLabel">禁用该用户</h4>
			</div>
			<div class="modal-body" id="enablebodycontent">
				<span>备注：</span><span><textarea rows="3" cols="" id="disablereson"></textarea></span>
				<!-- 在这里添加一些文本 -->
			</div>
			<div class="modal-footer" id="isenablebutton"></div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal -->
</div>

<div class="modal fade" id="editTelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog" style="width: 820px;">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="ModalLabel2">运营手机号(选填)</h4>
			</div>
			<div class="modal-body" id="bodycontent2" style="height: 120px; overflow: auto;">
				<div id="videoTrans">
					<div class="form-group">
						<label class="col-sm-2 control-label" for="ds_username">运营手机号</label>
						<div class="col-sm-4">
							<input class="form-control" id="telNo" type="text" maxlength="11" /> <input class="form-control" id="membGagaId"
								type="hidden" />
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
				<button type="button" onclick="submiteTel();" class="btn btn-primary">提交</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="Modal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog" style="width: 820px;">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="ModalLabel2">绑定机器账号</h4>
			</div>
			<div class="modal-body" id="bodycontent2" style="height: 120px; overflow: auto;">
				<div id="videoTrans">
					<div class="form-group">
						<label class="col-sm-2 control-label" for="ds_username">嘎嘎账号</label>
						<div class="col-sm-4">
							<input class="form-control" id="machineGagaNo" type="text" maxlength="15" />
						</div>
					</div>
				</div>
				<div id="videoTrans">
					<label for="content" class="col-sm-2 control-label">会员类型：</label>
					<div class="col-sm-4">
						<select name="machineTypeSub" id="machineTypeSub" class="form-control">
							<option value="1">智能营销会员</option>
							<option value="2">运营营销会员</option>
						</select>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
				<button type="button" onclick="bindMachine();" class="btn btn-primary">提交</button>
			</div>
		</div>
	</div>
</div>
<script>
	$(function() {

		$('#startRegistertime').datepicker({
			format : 'yyyy-mm-dd'
		});
		$('#endRegistertime').datepicker({
			format : 'yyyy-mm-dd'
		});
		$('#startMelotime').datepicker({
			format : 'yyyy-mm-dd'
		});
		$('#endMelotime').datepicker({
			format : 'yyyy-mm-dd'
		});

		//$('#startRegistertime').daterangepicker({format: 'YYYY-MM-DD'});
		//$('#startMelotime').daterangepicker({format: 'YYYY-MM-DD'}); .min '/plugins/datatables/jquery.dataTables.js', 
		$
				.addFields(
						[
								'/plugins/datatables/dataTables.bootstrap.min.js',
								'/plugins/iCheck/icheck.min.js',
								'/plugins/datatables/extensions/TableTools/js/dataTables.tableTools.min.js',
								'/plugins/datepicker/datepicker3.css',
								'/plugins/datepicker/bootstrap-datepicker.js',
								'/plugins/daterangepicker/daterangepicker-bs3.css',
								'/plugins/daterangepicker/daterangepicker.js' ],
						function() {
							var tabs = $("#memberinfo")
									.dataTable(
											{
												//"bProcessing": true,
												// "bServerSide": true,
												"bStateSave" : true, //保存客户端搜索条件等状态
												"paging" : true, //是否开启本地分页
												//"processing": true,   正在处理
												"serverSide" : true, //加载就请求后台
												"lengthChange" : false, //是否允许用户修改每页显示条数
												"searching" : false, //是否启用本地搜索
												"ordering" : true, //是否排序
												"info" : true, //是否显示左下角表格信息
												"autoWidth" : false, //自适应宽度
												"pageLength" : 10,
												//"ajax" : ctx+"/adminmember/notauditedimgList",
												"fnServerData" : function(
														sSource, aoData,
														fnCallback, oSettings) { //从服务器返回数据
													var membNickname = $(
															"#membNickname")
															.val();
													var ischeck = $("#nolike")
															.is(':checked');
													var nolike = "";
													if (ischeck) {
														nolike = 1
													}
													//var nolike = $("#nolike").val();
													var membGagano = $(
															"#membGagano")
															.val();
													//var membCountry = $("#membCountry").val();
													var membIp = $("#membIp")
															.val();
													var membEmail = $(
															"#membEmail").val();
													var membSex = $("#membSex")
															.val();
													var membLanguage = $(
															"#membLanguage")
															.val();
													var membIsenable = $(
															"#membIsenable")
															.val();
													var membShowtop = "";
													var showischeck = $(
															"#membShowtop").is(
															':checked');
													if (showischeck) {
														membShowtop = "1";
													}
													var startRegistertime = $(
															"#startRegistertime")
															.val();
													var endRegistertime = $(
															"#endRegistertime")
															.val();
													var startMelotime = $(
															"#startMelotime")
															.val();
													var endMelotime = $(
															"#endMelotime")
															.val();
													var filteripcheck = $(
															"#filterip").is(
															':checked');
													var filterip = "";
													if (filteripcheck) {
														filterip = "1";
													}
													aoData
															.push(
																	{
																		"name" : "orderval",
																		"value" : aoData[2].value[0]["dir"]
																	},
																	{
																		"name" : "membNickname",
																		"value" : membNickname
																	},
																	{
																		"name" : "nolike",
																		"value" : nolike
																	},
																	{
																		"name" : "membGagano",
																		"value" : membGagano
																	},
																	//{"name":"membCountry","value":membCountry},
																	{
																		"name" : "membIp",
																		"value" : membIp
																	},
																	{
																		"name" : "membEmail",
																		"value" : membEmail
																	},
																	{
																		"name" : "membSex",
																		"value" : membSex
																	},
																	{
																		"name" : "membLanguage",
																		"value" : membLanguage
																	},
																	{
																		"name" : "membIsenable",
																		"value" : membIsenable
																	},
																	{
																		"name" : "membShowtop",
																		"value" : membShowtop
																	},
																	{
																		"name" : "startRegistertime",
																		"value" : startRegistertime
																	},
																	{
																		"name" : "endRegistertime",
																		"value" : endRegistertime
																	},
																	{
																		"name" : "startMelotime",
																		"value" : startMelotime
																	},
																	{
																		"name" : "endMelotime",
																		"value" : endMelotime
																	},
																	{
																		"name" : "filterip",
																		"value" : filterip
																	},
																	{
																		"name" : "machineFilter",
																		"value" : "1"
																	},
																	{
																		"name" : "machineType",
																		"value" : $(
																				'#machineType')
																				.val()
																	},
																	{
																		"name" : "mobile",
																		"value" : $(
																				'#mobile')
																				.val()
																	})
													layer.load(1, {
														shade : 0.3
													}); //加遮罩层
													var url = (tabs) ? (ctx + "/adminmember/memberList")
															: "#";
													oSettings.jqXHR = $.ajax({
														"dataType" : 'json',
														"type" : "POST",
														"url" : url,
														"data" : aoData,
														"success" : fnCallback
													});
												},
												"columns" : [
														{
															"data" : "membGagaid",
															"bSortable" : false
														}, //data   我们需要的某一列数据对应的属性名
														{
															"data" : "membBigimg",
															"bSortable" : false,
															"render" : function(
																	data, type,
																	full, meta) {
																if (data
																		&& data
																				.indexOf("http") > -1) {
																	return '<img style="width:100px;" alt="" src="'+data+'">';
																} else {
																	return '<img style="width:100px;" alt="" src="'+qiniu+data+'">';
																}
															}
														},
														{
															"data" : "membNickname",
															"bSortable" : false
														},
														{
															"data" : "membGagano",
															"bSortable" : false
														},
														{
															"data" : "membRegistertime",
															"bSortable" : false,
															"render" : function(
																	data, type,
																	full, meta) {
																if (data == ''
																		|| data == null) {
																	return "";
																}
																var date = new Date(
																		data);
																return date
																		.getFullYear()
																		+ "-"
																		+ (date
																				.getMonth() + 1)
																		+ "-"
																		+ date
																				.getDate()
																		+ " "
																		+ date
																				.getHours()
																		+ ":"
																		+ date
																				.getMinutes()
																		+ ":"
																		+ date
																				.getSeconds();
															}
														},
														{
															"data" : "",
															"bSortable" : false,
															"render" : function(
																	data, type,
																	full, meta) {
																return '<a href="javascript:void(0)" onclick="delBindMachine('
																		+ full.membGagaid
																		+ ')">解绑</a> <br/><a href="javascript:void(0)" onclick="editTelView('
																		+ full.membGagaid
																		+ ')">绑定手机号</a>';
															}
														} ],
												"fnDrawCallback" : function(
														oSettings) {//这个应该是重绘的回调函数
													layer.closeAll();
												}
											});
							//序号相关
							var table = $('#memberinfo').DataTable();
							table.on(
									'order.dt search.dt',
									function() {
										//获取页信息
										var page = table.page.info();
										table.column(0, {}).nodes().each(
												function(cell, i) {
													cell.innerHTML = page.page
															* page.length + i
															+ 1;
												});
									}).draw();

						})
	});
	function search() {
		// $("#memberinfo").dataTable();
		$("#memberinfo").dataTable().fnDraw(true);
	}

	//绑定
	function bindView() {
		$("#machineGagaNo").val("");
		$('#Modal2').modal({
			keyboard : true
		});
	}
	//运营手机号
	function editTelView(gagaId) {
		$.ajax({
			type : "post",
			url : ctx + "/machineMember/getTel",
			data : {
				membGagaId : gagaId
			},
			dataType : "json",
			success : function(result) {
				if (result.success) {
					$("#telNo").val(result.obj);
					$('#editTelModal').modal({
						keyboard : true
					});
					$('#membGagaId').val(gagaId);
				} else {
					alert("获取手机号失败");
				}
			}
		});
	}

	//绑定
	function bindMachine() {
		var _gagaNo = $("#machineGagaNo").val();
		if (!_gagaNo) {
			alert("请输入内容!");
			return;
		}
		$.ajax({
			type : "post",
			url : ctx + "/machineMember/bindMachine",
			dataType : "json",
			data : {
				"gagaNo" : _gagaNo,
				"machineType" : $('#machineTypeSub').val()
			},
			success : function(result) {
				if (result.success) {
					alert("绑定成功");
					$('#Modal2').modal('hide');
					search();
				} else {
					alert(result.msg);
				}
			}
		});
	}
	//刷新缓存
	function refreshCache() {
		$.ajax({
			url : ctx + "/machineMember/refreshMachineMemberList",
			success : function(result) {
				if (result.success) {
					var _size = result.obj.length;
					alert("刷新成功,缓存大小[" + _size + "]");
				} else {
					alert("刷新失败");
				}
			}
		});
	}

	//解除绑定
	function delBindMachine(membGagaid) {
		if (!membGagaid) {
			return;
		}
		$.ajax({
			type : "post",
			url : ctx + "/machineMember/delBindMachine",
			dataType : "json",
			data : {
				"membGagaid" : membGagaid
			},
			success : function(result) {
				if (result.success) {
					alert("解绑成功");
					search();
				} else {
					alert("解绑失败");
				}
			}
		});
	}

	//运营手机号
	function submiteTel() {
		var _telNo = $("#telNo").val();
		if (_telNo && _telNo.length != 11) {
			alert("手机号必须11位!");
			return;
		}
		$.ajax({
			type : "post",
			url : ctx + "/machineMember/submiteTel",
			dataType : "json",
			data : {
				"mobileNo" : _telNo,
				"membGagaId" : $('#membGagaId').val()
			},
			success : function(result) {
				if (result.success) {
					alert("修改成功");
					$('#editTelModal').modal('hide');
				} else {
					alert("修改失败");
				}
			}
		});
	}
</script>
</body>
</html>
