<style>
    .layui-upload-img {
        width: 92px;
        height: 92px;
        margin: 0 10px 10px 0;
    }
</style>
<section class="content-header">
    <h1>
        探索管理
        <small></small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i>主页</a></li>
        <li>模块管理</li>
        <li class="active">探索管理</li>
    </ol>
</section>

<div class="layui-fluid">
    <div class="layui-row">
        <form class="layui-form" action="">

            <div class="layui-form-item">
                <label class="layui-form-label">标题</label>
                <div class="layui-input-block">
                    <input id="btmsg" type="text" name="" placeholder="请输入" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">分类</label>
                <div class="layui-input-block">
                    <select name="contClassCode_s" id="stylemsg">
                        <option value="">全部</option>
                        <option value="2">抗击肺炎</option>
                        <option value="3">娱乐</option>
                        <option value="4">情感</option>
                        <option value="5">影视</option>
                        <option value="6">搞笑</option>
                        <option value="7">游戏</option>
                        <option value="8">科技</option>
                        
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <select name="interest" lay-filter="aihao" id="statemsg">
                        <option value="0">全部</option>
                        <option value="2">上线</option>
                        <option value="1">未上线</option>
                    </select>
                </div>
            </div>

        </form>
        <button class="layui-btn" id="searchEx">搜索</button>
        <button class="layui-btn" id="addExplore">新增</button>
    </div>
    <div class="layui-fluid">
        <table class="layui-hide" id="exploreTable" lay-filter="exploreTable"></table>
    </div>
</div>
<script type="text/html" id="contConfig">
    <div class="layui-row">
        <br/>
        <form class="layui-form" lay-filter="contConfigForm">
            <input type="hidden" name="contentCode" id="contentCode" value=""/>
            <div class="layui-form-item">
                <label class="layui-form-label">分类</label>
                <div class="layui-input-block">
                    <select name="contClassCode">
						<option value="2">抗击肺炎</option>
                        <option value="3">娱乐</option>
                        <option value="4">情感</option>
                        <option value="5">影视</option>
                        <option value="6">搞笑</option>
                        <option value="7">游戏</option>
                        <option value="8">科技</option>
						
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">收费语言</label>
                <div class="layui-input-block">
                    <select name="chargeLanguage">
                        <option value="zh-cn">中</option>
                        <option value="zh-tw">繁</option>
                        <option value="en-us">英</option>
                        <option value="de-de">德</option>
                        <option value="ja-jp">日</option>
                        <option value="ko-kr">韩</option>
                        <option value="ru-ru">俄</option>
                        <option value="es-es">西</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">排序（倒序）</label>
                <div class="layui-input-block">
                    <input type="text" name="contentSort" placeholder="请输入" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
            <!--		<div class="layui-form-item">
                        <label class="layui-form-label">阅读量</label>
                        <div class="layui-input-block">
                            <input type="text" name="contentReadNum" placeholder="请输入" autocomplete="off"
                                class="layui-input">
                        </div>
                    </div> -->
            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <input type="radio" name="contentStatus" value="2" title="上线">
                    <input type="radio" name="contentStatus" value="1" title="下线" checked>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">置顶</label>
                <div class="layui-input-block">
                    <input type="radio" name="contentTop" value="2" title="是">
                    <input type="radio" name="contentTop" value="1" title="否" checked>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">是否推送到官方公告</label>
                <div class="layui-input-block">
                    <input type="radio" name="contentPush" value="2" title="是">
                    <input type="radio" name="contentPush" value="1" title="否" checked>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
                <legend>上传图片</legend>
            </fieldset>

            <div class="layui-upload" style="overflow:hidden">
                <button type="button" class="layui-btn" id="test2">图片上传</button>
                <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                    预览图：
                    <div class="layui-upload-list" id="demo2"></div>
                </blockquote>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="editConfigSubmit">立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</script>

<script type="text/html" id="openEdit">
    <div class="layui-row">
        <input type="hidden" id="contCode_t" value=""/>
        <div class="layui-tab layui-tab-card" lay-filter="languageTabs">
            <ul class="layui-tab-title">
                <li class="layui-this" lay-id="zh-cn">中</li>
                <li lay-id="zh-tw">中繁</li>
                <li lay-id="en-us">英</li>
                <li lay-id="ja-jp">日</li>
                <li lay-id="ko-kr">韩</li>
                <li lay-id="de-de">德</li>
                <li lay-id="es-es">西</li>
                <li lay-id="ru-ru">俄</li>
            </ul>
            <div class="layui-tab-content" style="height: 600px; width: 650px">
                <form class="layui-form" lay-filter="contFormAdd">

                    <input type="hidden" name="contCode" id="contCode" value=""/>
                    <input type="hidden" name="contId" value=""/>

                    <div class="layui-form-item">
                        <label class="layui-form-label">语言</label>
                        <div class="layui-input-block">
                            <input type="text" name="contLanguage" value="zh-cn" class="layui-input" readOnly>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">标题(255个字符)</label>
                        <div class="layui-input-block">
                            <input type="text" name="contTitle" placeholder="请输入"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">副标题(255个字符)</label>
                        <div class="layui-input-block">
                            <input type="text" name="contSubtitle" placeholder="请输入"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">第一段(500个字符)</label>
                        <div class="layui-input-block">
						<textarea name="contFirstParagraph" placeholder="请输入内容"
                                  class="layui-textarea" style="height: 100px"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">正文翻译内容</label>
                        <div class="layui-input-block">
						<textarea name="contContent" placeholder="请输入内容"
                                  class="layui-textarea" style="height: 250px"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="editContent">立即提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs" lay-event="editConfig">设置</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<script>
    layui.use(['form', 'upload', 'table', 'element'], function () {
        //获取form模块
        var form = layui.form, table = layui.table, element = layui.element, upload = layui.upload; //获取upload模块

        table.render({
            elem: '#exploreTable',
            url: ctx + '/explore/getContentList',
            where: {
                btmsg: $("#btmsg").val(),
                stylemsg: $("#stylemsg").val(),
                statusmsg: $("#statemsg").val()
            },
            //	method: 'post' //	默认 get
            //	contentType: 'application/json'
            toolbar: true,
            defaultToolbar: ['exports', 'filter'],
            even: true, //	开启隔行背景
            title: '探索发现',
            limits: [10, 30, 20, 20, 20, 50],
            cols: [[{
                field: 'cont_code',
                title: '序号',
                type: 'numbers'
            }, {
                field: 'cont_title',
                title: '标题',
                edit: 'text'
            }, {
                field: 'cont_subtitle',
                title: '副标题',
                width: 150
            }, {
                field: 'cont_first_paragraph',
                title: '第一段',
                width: 100
            }, {
                field: 'cont_content',
                title: '正文',
                width: 120
            }, {
                field: 'cla_name',
                title: '分类'
            }, {
                field: 'cont_create_time',
                title: '发布时间',
                templet: function (res) {
                    if (res != null) {
                        var date = new Date(res.cont_create_time);
                        return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                    }
                }
            }, {
                field: 'content_read_num_real',
                title: '阅读量'
            }, {
                field: 'content_like_num',
                title: '点赞量'
            }, {
                field: 'content_comments_num',
                title: '评论量'
            }, {
                field: 'content_reward_num',
                title: '打赏量'
            }, {
                field: 'content_forward_num',
                title: '转发量'
            }, {
                field: 'content_status',
                title: '状态'
                , templet: function (res) {
                    var dd = res.content_status
                    if (dd == 1) {
                        return '下线'
                    } else if (dd == 2) {
                        return '上线'
                    }
                }
            }, {
                fixed: 'right',
                title: '操作',
                width: 300,
                toolbar: '#barDemo'
            }]],
            page: true,
            done:function(res){
                tdTitle();
            }
        });

        //	监听行工具事件
        table.on('tool(exploreTable)', function (obj) {
            var data = obj.data;
            var contentCode = data.cont_code;
            console.log(data)
            console.log(obj.event)
            if (obj.event === 'del') {
                layer.confirm('真的删除行么', function (index) {
                    /* obj.del();
                    layer.close(index); */
                    $.ajax({
                        url: ctx + "/explore/deleteContent",
                        type: "POST",
                        data: {
                            "contentCode": contentCode
                            , "contentDelete": 2
                        },
                        dataType: "json",
                        success: function (data) {
                            layer.msg("操作成功！");
                            table.reload('exploreTable');
                        },
                        error: function (e) {
                            layer.msg("操作失败！");
                        },
                    });


                });
            } else if (obj.event === 'edit') {
                layer.open({
                    type: 1,
                    title: "内容编辑",
                    area: ['700px', '720px'],
                    content: $("#openEdit").html()
                });

                $('#contCode_t').val();
                $('#contCode_t').val(data.cont_code);
                getData(data.cont_code, data.cont_language);
            } else if (obj.event == 'editConfig') {
                $.ajax({
                    url: ctx + "/explore/getContentConfig",
                    type: "POST",
                    data: {
                        "contentCode": contentCode
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data) {
                            layer.open({
                                type: 1,
                                title: "内容编辑",
                                area: ['800px', '800px'],
                                content: $("#contConfig").html()
                            });
                            var config = data.config;
                            var imgs = data.imgs;
                            form.val("contConfigForm", {
                                "contentCode": contentCode,
                                "chargeLanguage": config.chargeLanguage,
                                "contClassCode": config.contClassCode,
                                "contentChars": config.contentChars,
                                "contentReadNum": config.contentReadNum,
                                "contentSort": config.contentSort,
                                "contentStatus": String(config.contentStatus),
                                "contentTop": String(config.contentTop),
                                "contentPush": String(config.contentPush)
                            });
                            if (imgs) {
                                $('#oneImage').remove();
                                for (let a of imgs) {
                                    $('#demo2').append('<div id="oneImage" style="float:left;"><img src="' + a.imgUrl + '" class="layui-upload-img">'
                                        + '<input type="hidden" name="imgs" value="' + a.imgUrl + '" /></div>');
                                }
                            }

                            //	图片上传
                            var fileName;
                            var uploadInst = upload.render({
                                elem: '#test2',
                                url: Qiniu_UploadUrl,
                                accept: "images",
                                choose: function (obj) {
                                    //	预读本地文件示例，不支持ie8
                                    obj.preview(function (index, file, result) {
                                        fileName = file.name;
                                    });
                                },
                                data: getUploadToken(fileName),
                                done: function (res) {
                                    //	上传完毕
                                    console.log(JSON.stringify(res));
                                    layer.msg("上传成功！");
                                    var imgUrlnew = qiniuVedio + res.key;
                                    $('#oneImage').remove();
                                    $('#demo2').append('<div id="oneImage"><img src="' + imgUrlnew + '" class="layui-upload-img">');
                                    $('#demo2').append('<input type="hidden" name="imgs" value="' + imgUrlnew + '" /></div>');
                                },
                                error: function (index, upload) {
                                    layer.msg("上传失败！");
                                }
                            });

                        }
                    }
                });
            }
        });

        function getData(contCode, contLanguage) {
            $.ajax({
                url: ctx + "/explore/getContent",
                type: "POST",
                data: {
                    "contCode": contCode,
                    "contLanguage": contLanguage
                },
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    if (data) {
                        console.log(contCode)
                        form.val("contFormAdd", {
                            "contCode": contCode,// "name": "value"
                            "contContent": data.contContent,
                            "contFirstParagraph": data.contFirstParagraph,
                            "contId": data.contId,
                            "contLanguage": data.contLanguage,
                            "contSubtitle": data.contSubtitle,
                            "contTitle": data.contTitle
                        });
                    } else {
                        layer.msg('数据为空');
                    }
                },
                error: function (e) {
                    layer.msg('请求失败');
                },
            });
        }

        //		监听Tab切换
        element.on('tab(languageTabs)', function (data) {
            $('#contLanguage').val(this.getAttribute('lay-id'));
            var contCode = $('#contCode_t').val();
            var contLanguage = this.getAttribute('lay-id');
            console.log(contCode)
            getData(contCode, contLanguage);

        });

        //	添加编辑文章 按钮
        form.on('submit(editContent)', function (data) {
            console.log(data.field);//当前容器的全部表单字段，名值对形式：{name: value}
            $.ajax({
                url: ctx + "/explore/addContent",
                type: "POST",
                data: data.field,
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        layer.msg('操作成功');
                        table.reload('exploreTable');
                    } else {
                        layer.msg(data.msg);
                    }
                },
                error: function (e) {

                },
            });
            return false;//阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
        //	设置提交 按钮
        form.on('submit(editConfigSubmit)', function (data) {
            var dd = data.field;
            delete dd.file;
            console.log(data.field);//当前容器的全部表单字段，名值对形式：{name: value}
            console.log(dd);//当前容器的全部表单字段，名值对形式：{name: value}
            console.log(data.field.imgs);
            if (!data.field.imgs) {
                layer.msg('请上传图片');
                return false;
            }
            $.ajax({
                url: ctx + "/explore/editContentConfig",
                type: "POST",
                data: data.field,
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        layer.msg('操作成功');
                    } else {
                        if (data.obj == 1) {
                            layer.msg('请把多语言添加完整再上线');
                        } else {
                            layer.msg('操作失败');
                        }

                    }
                },
                error: function (e) {
                    layer.msg('操作失败');
                },
            });
            return false;//阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
        //		搜索 按钮
        $('#searchEx').click(function () {
            table.reload('exploreTable', {
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                , where: {
                    btmsg: $("#btmsg").val(),
                    stylemsg: $("#stylemsg").val(),
                    statusmsg: $("#statemsg").val()
                }
            });
        });
        //	新增  按钮
        $("#addExplore").click(function (e) {
            layer.open({
                type: 1,
                title: "内容编辑",
                area: ['700px', '720px'],
                content: $("#openEdit").html()
            });
            $('#contCode_t').val();
            var uuid = guid().replace(/-/g, '');
            console.log(uuid);
            $('#contCode_t').val(uuid);
            $('#contCode').val(uuid);
        });

    });

    function guid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function getUploadToken(imgName) {
        var token;
        $.ajax({
            url: ctx + "/Image/getCoverToken",
            async: false,
            data: {
                "name": imgName
            },
            dataType: "json",
            success: function (data) {
                token = data;
            }
        });
        return token;
    }
    
    function tdTitle(){
        $('th').each(function(index,element){
            $(element).attr('title',$(element).text());
        });
        $('td').each(function(index,element){
            $(element).attr('title',$(element).text());
        });
    };
</script>



